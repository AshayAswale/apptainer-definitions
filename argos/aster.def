Bootstrap: docker
From: {{ DOCKER_BASE }}

# ===================================
# === Manually configurable setup ===
%arguments

  VERSION=v0.11

  DOCKER_BASE=dcat52/argos-requirements:20.04-minimum

  NUM_BUILD_THREADS=20

  # REPO SOURCE ORGS
  # commonly "ilpincy" or "NESTLab" or "buzz-lang"
  ORG_ARGOS=ilpincy
  ORG_ARGOS_EXAMPLES=NA
  ORG_BUZZ=NA
  ORG_KHEPERAIV=NA
  ORG_WEBVIZ=NA
  ORG_VICON=NA

  # GIT HASHES
  # use "latest" for most recent commit
  HASH_ARGOS=latest
  HASH_ARGOS_EXAMPLES=latest
  HASH_BUZZ=latest
  HASH_KHEPERAIV=latest
  HASH_WEBVIZ=feature/update-cmake
  HASH_VICON=latest
  
  # use "Debug" or "Release"
  BUILD_TYPE=Debug

  # use "OFF" or "ON"
  BUILD_DOC=OFF
  BUILD_LUA=OFF
  BUILD_NATIVE=OFF
  ARGOS_INSTALL_LDSOCONF=ON

  PACKAGES=/user-packages

  # defaults to "/usr/local/"
  INSTALL_PREFIX=/usr/local/
  #"/user-packages/local/"

# ===================================
# ===================================

%labels
  AUTHOR daviscatherman@gmail.com
  VERSION {{ VERSION }}
  NAME ASTER_environment

%help
  This container installs ARGoS3, ARGoS3-Examples, Buzz, and KheperaIV.
  You can launch this container as a shell, or directly run ARGoS programs by replacing the executable of argos3 with the container.

  View the Labels to see the configuration used of the built container.

%environment
  export PATH={{ INSTALL_PREFIX }}/bin/:$PATH
  export LD_LIBRARY_PATH={{ INSTALL_PREFIX }}/lib/:$LD_LIBRARY_PATH
  export INSTALL_PREFIX={{ INSTALL_PREFIX }}
  export CMAKE_INCLUDE_PATH={{ INSTALL_PREFIX }}
  export BUILD_TYPE={{ BUILD_TYPE }}
  export PACKAGES={{ PACKAGES }}

%setup
  mkdir -p ${APPTAINER_ROOTFS}/{{ PACKAGES }}
  . definitions/include/helper.sh
  add_helper
  add_bashrc
  add_sshauthsock

%post -c /bin/bash
  . /.singularity.d/env/90-bashrc.sh
  
  umask 000

  PACKAGES={{ PACKAGES }}

  mkdir -p $PACKAGES
  cd $PACKAGES
  
  export DEBIAN_FRONTEND=noninteractive

  apt update -y
  apt install -qy git bc gdb tree
  export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=accept-new"

  apt install -qy cmake-curses-gui

  if ! dfx_string_contains {{ DOCKER_BASE }} dcat52; then
    # pre-reqs only need installed if not preinstalled n the container
    apt install -qy cmake libfreeimage-dev libfreeimageplus-dev \
      freeglut3-dev libxi-dev libxmu-dev build-essential
  fi

  # this pre-req will require python
  apt install -qy qt5-default python3-pip

  apt install -qy zlib1g-dev libssl-dev

  if [ "{{ BUILD_LUA }}" = "ON" ]; then
    apt install -qy liblua5.3-dev lua5.3
  fi

  if [ "{{ BUILD_DOC }}" = "ON" ]; then
    apt install -qy doxygen asciidoc graphviz libgraphviz-dev
  fi

  apt install -qy curl lsb-release lsb-core
  sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
  curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add -
  apt -qy update
  apt install -qy ros-noetic-ros-comm ros-noetic-geometry-msgs

  . /opt/ros/noetic/setup.sh
  addto_bashrc ". /opt/ros/noetic/setup.sh"


  cd $PACKAGES
  
  dfx_clone_and_checkout {{ HASH_ARGOS }} {{ ORG_ARGOS }} argos3

  mkdir build_simulator
  cd build_simulator

  if [ "{{ BUILD_TYPE }}" = "Debug" ]; then
    cmake \
      -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
      -DCMAKE_BUILD_TYPE=Debug \
      -DARGOS_DOCUMENTATION={{ BUILD_DOC }} \
      -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
      ../src
  elif [ "{{ BUILD_TYPE }}" = "Release" ]; then
    cmake \
      -DCMAKE_BUILD_TYPE=Release \
      -DARGOS_FORCE_NO_QTOPENGL=ON \
      -DARGOS_DOCUMENTATION={{ BUILD_DOC }} \
      -DARGOS_INSTALL_LDSOCONF={{ ARGOS_INSTALL_LDSOCONF }} \
      -DARGOS_BUILD_NATIVE={{ BUILD_NATIVE }} \
      -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
      ../src
  fi

  make -j {{ NUM_BUILD_THREADS }}
  if [ "{{ BUILD_DOC }}" = "ON" ]; then
    make doc
  fi
  make install
  ldconfig

  cd $PACKAGES

  dfx_clone_and_checkout {{ HASH_ARGOS_EXAMPLES }} {{ ORG_ARGOS_EXAMPLES }} argos3-examples
  
  if [ ! "{{ ORG_ARGOS_EXAMPLES }}" = "NA" ]; then
    mkdir build
    cd build
    if [ "{{ BUILD_TYPE }}" = "Debug" ]; then
        cmake \
          -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
          ..
    elif [ "{{ BUILD_TYPE }}" = "Release" ]; then
        cmake \
          -DCMAKE_BUILD_TYPE=Release  \
          -DARGOS_FORCE_NO_QTOPENGL=ON \
          -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
          ..
    fi
    make -j {{ NUM_BUILD_THREADS }}
  fi

  cd $PACKAGES
  dfx_clone_and_checkout {{ HASH_BUZZ }} {{ ORG_BUZZ }} Buzz buzz
  
  if [ ! "{{ ORG_BUZZ }}" = "NA" ]; then
    mkdir build
    cd build
  
    if [ "{{ BUILD_TYPE }}" = "Debug" ]; then
      cmake \
        -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
        ../src
    elif [ "{{ BUILD_TYPE }}" = "Release" ]; then
      cmake \
        -DCMAKE_BUILD_TYPE=Release  \
        -DARGOS_FORCE_NO_QTOPENGL=ON \
        -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
        ../src
    fi
  
    make -j {{ NUM_BUILD_THREADS }}
    make install
    ldconfig
  fi

  cd $PACKAGES

  dfx_clone_and_checkout {{ HASH_KHEPERAIV }} {{ ORG_KHEPERAIV }} argos3-kheperaiv
  
  if [ ! "{{ ORG_KHEPERAIV }}" = "NA" ]; then
    mkdir build_sim
    cd build_sim

    if [ "{{ BUILD_TYPE }}" = "Debug" ]; then
      cmake \
        -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
        ../src
    elif [ "{{ BUILD_TYPE }}" = "Release" ]; then
      cmake \
        -DCMAKE_BUILD_TYPE=Release  \
        -DARGOS_FORCE_NO_QTOPENGL=ON \
        -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
        ../src
    fi

    make -j {{ NUM_BUILD_THREADS }}
    make install
    ldconfig
  fi

  cd $PACKAGES

  dfx_clone_and_checkout {{ HASH_WEBVIZ }} {{ ORG_WEBVIZ }} argos3-webviz
  
  if [ ! "{{ ORG_WEBVIZ }}" = "NA" ]; then
    mkdir build
    cd build

    cmake \
      -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
      -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
      ../src

    make -j {{ NUM_BUILD_THREADS }}
    make install
    ldconfig
  fi

  cd $PACKAGES

  dfx_clone_and_checkout {{ HASH_VICON }} {{ ORG_VICON }} Vicon vicon
  
  if [ ! "{{ ORG_VICON }}" = "NA" ]; then
    mkdir build
    cd build
    cmake ..
  
    make -j {{ NUM_BUILD_THREADS }}
    make install
    ldconfig
  fi

  cd $PACKAGES
  dfx_clone_and_checkout ros-actuator ilpincy argos3-leo
  mkdir build_sim
  cd build_sim
  cmake \
    -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
    -DCMAKE_BUILD_TYPE=Debug \
    -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
    ../src
  make -j {{ NUM_BUILD_THREADS }}
  make install
  ldconfig

  cd $PACKAGES
  git clone ssh://git@git.collab.cra.com:7999/aster/caf-cpp.git
  cd caf-cpp
  mkdir build
  cd build
  cmake \
    -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
    -DCMAKE_BUILD_TYPE=Debug \
    -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
    ..
  make -j {{ NUM_BUILD_THREADS }}
  make install
  ldconfig

  cd $PACKAGES
  dfx_clone_and_checkout v3.11.3 nlohmann json
  mkdir build
  cd build
  cmake \
    -DCMAKE_CXX_FLAGS="-fno-omit-frame-pointer -fsanitize=address " \
    -DCMAKE_INSTALL_PREFIX={{ INSTALL_PREFIX }} \
    ..
  make -j {{ NUM_BUILD_THREADS }}
  make install
  
  # remove a section of libQt5 to work on Turing
  strip --remove-section=.note.ABI-tag /usr/lib/x86_64-linux-gnu/libQt5Core.so.5
  # empty the cache to reduce image size
  # apt clean

  # add created on info to label
  DT=`date`
  echo CREATED_ON $DT >> "$APPTAINER_LABELS"

  # store the build type into a label
  echo _BUILD_TYPE {{ BUILD_TYPE }} >>  "$APPTAINER_LABELS"
  # store whether build native into a label
  echo _BUILD_NATIVE {{ BUILD_NATIVE }} >>  "$APPTAINER_LABELS"
  # store whether build doc into a label
  echo _BUILD_DOC {{ BUILD_DOC }} >>  "$APPTAINER_LABELS"

  # store the git hashes into labels
  echo _ORG_ARGOS {{ ORG_ARGOS }} >> "$APPTAINER_LABELS"
  echo _ORG_ARGOS_EXAMPLES {{ ORG_ARGOS_EXAMPLES }} >> "$APPTAINER_LABELS"
  echo _ORG_BUZZ {{ ORG_BUZZ }} >> "$APPTAINER_LABELS"
  echo _ORG_KHEPERAIV {{ ORG_KHEPERAIV }} >> "$APPTAINER_LABELS"
  echo _ORG_WEBVIZ {{ ORG_WEBVIZ }} >> "$APPTAINER_LABELS"
  echo _ORG_VICON {{ ORG_VICON }} >> "$APPTAINER_LABELS"
  
  echo _HASH_ARGOS {{ HASH_ARGOS }} >> "$APPTAINER_LABELS"
  echo _HASH_ARGOS_EXAMPLES {{ HASH_ARGOS_EXAMPLES }} >> "$APPTAINER_LABELS"
  echo _HASH_BUZZ {{ HASH_BUZZ }} >> "$APPTAINER_LABELS"
  echo _HASH_KHEPERAIV {{ HASH_KHEPERAIV }} >> "$APPTAINER_LABELS"
  echo _HASH_WEBVIZ {{ HASH_WEBVIZ }} >> "$APPTAINER_LABELS"
  echo _HASH_VICON {{ HASH_VICON }} >> "$APPTAINER_LABELS"
